tinymce.PluginManager.add('external_tool', function (editor, url) {
    function openmanager() {
//        jQuery("#ExternalToolModal").modal("show");
        var win, data, dom = editor.dom,
            imgElm = editor.selection.getNode();
        var width, height, imageListCtrl;
        win = editor.windowManager.open({
            title: 'External Resource',
            file: tinyMCE.baseURL + '/plugins/external_tool/dialog.php?editor=' + editor.id + '&lang=' + tinymce.settings.language + '&subfolder=' + tinymce.settings.subfolder,
            filetype: 'all',
            classes: 'filemanager',
            width: 900,
            height: 300,
            inline: 1,
            onsubmit: embedHTML,
            buttons: [{ 
                text: 'Insert Iframe',
                subtype: 'primary',
                onclick: 'submit'
              },
              {
                text: 'Close',
                onclick: 'close'
               }
            ],
        });
    }
    /**************Embeding HTML in browser *****************/
    var embedHTML = function (e) {
        
        tinymce.activeEditor.execCommand('mceInsertContent', false, '<p>' + tinymce.activeEditor.d + '</p>');
        top.tinymce.activeEditor.windowManager.close();
        var html = tinymce.activeEditor.d;
        console.log(html);
        var dom_nodes = jQuery(jQuery.parseHTML(html));
        console.log(dom_nodes);
        var type_id =  dom_nodes.find('input[name=type_id]').val();
        var lti_id =  dom_nodes.find('input[name=lti_id]').val();
//        tinymce.activeEditor.setContent(html, {format: 'raw'});

        jQuery('<input>').attr({
            type: 'hidden',
            value: lti_id,
            name: 'lti_id'
        }).prependTo('form#create_resource_form');
        
        jQuery('<input>').attr({
            type: 'hidden',
            value: type_id,
            name: 'type_id'
        }).prependTo('form#create_resource_form');

//        editor.uploadedfile.html = '';
//
//        jQuery('<input>').attr({
//            type: 'hidden',
//            value: JSON.stringify(editor.uploadedfile),
//            name: 'resourcefiles[]'
//        }).prependTo('form#create_resource_form');
    }
    // Add a button that opens a window
    editor.addButton('external_tool', {
        text: 'External Resource',
        tooltip: 'Insert LTI Tool',
        icon: false,
        onclick: openmanager
    });

    editor.addMenuItem('external_tool', {
        text: 'External Resource',
        tooltip: 'Insert LTI Tool',
        icon: false,
        context: 'insert',
        onclick: openmanager
    });

});

